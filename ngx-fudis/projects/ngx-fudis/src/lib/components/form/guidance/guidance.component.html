@let parentFormId = _parentFormId();

<div class="fudis-guidance" [id]="_id">
  <div [id]="for + '_guidance'">
    <div
      [id]="_id + '-errors'"
      [class.fudis-guidance__errors]="
        _afterViewInitDone() &&
        ((control && control.touched) || (formGroup && formGroup.touched && groupBlurredOut))
      "
      >
      @if (
        (control?.invalid && control?.touched) ||
        (formGroup?.invalid && formGroup?.touched && groupBlurredOut)
        ) {
        <fudis-icon
          [icon]="'alert-fill'"
          />
      }
      <div class="fudis-guidance__errors__list">
        <!--
        Check errors for each control FormGroup e. g. english, finnish, swedish
        -->
        @if (formGroup?.controls && !control && !formGroup?.errors) {
          @for (singleControl of formGroup?.controls | keyvalue; track singleControl.key) {
            @if (singleControl.value.errors) {
              @for (error of singleControl.value.errors | keyvalue; track error.key) {
                @if (error.value.message) {
                  <fudis-validator-error-message
                    (handleCreateError)="_reloadErrorSummaryOnLazyLoad($event)"
                    [formId]="parentFormId"
                    [focusId]="for"
                  [visible]="
                    !!((singleControl.value.touched || formGroup.touched) && groupBlurredOut)
                  "
                    [type]="error.key"
                    [controlName]="singleControl.key"
                    [label]="inputLabel"
                    [message]="error.value.message"
                    />
                }
              }
            }
          }
        }

        <!--
        Check parent level errors of FormGroup e. g. oneRequired
        -->
        @if (formGroup?.errors && formGroup?.invalid) {
          @for (error of formGroup?.errors | keyvalue; track error.key) {
            @if (error.value?.message) {
              <fudis-validator-error-message
                (handleCreateError)="_reloadErrorSummaryOnLazyLoad($event)"
                [formId]="parentFormId"
                [visible]="!!(formGroup.touched && groupBlurredOut)"
                [focusId]="for"
                [type]="error.key"
                [label]="inputLabel"
                [message]="error.value?.message"
                />
            }
          }
        }

        <!--
        Check errors for single FormControl e. g. single text-input with maxlength error
        -->
        @if (control?.errors && !formGroup) {
          @for (error of control.errors | keyvalue; track error.key) {
            @if (error.value?.message) {
              <fudis-validator-error-message
                (handleCreateError)="_reloadErrorSummaryOnLazyLoad($event)"
                [formId]="parentFormId"
                [visible]="control.touched"
                [focusId]="for"
                [type]="error.key"
                [label]="inputLabel"
                [message]="error.value?.message"
                />
            }
          }
        }
        <ng-content />
      </div>
    </div>

    @if (helpText || (control && maxLength)) {
      <p
        [attr.aria-hidden]="groupHelpTextHidden"
        class="fudis-guidance__help-text"
        >
        @if (helpText) {
          {{ helpText }}
        }
      </p>
    }
  </div>
  @if (maxLength && control) {
    <small
      class="fudis-guidance__character-limit-indicator fudis-guidance__character-limit-indicator__{{
        _maxLengthWidth
      }}"
      [class.fudis-guidance__character-limit-indicator__float-right]="!helpText"
      >
      {{ control.value?.length || 0 }}/{{ maxLength }}
      <span class="fudis-visually-hidden">{{ _maxLengthText | async }}</span>
    </small>
  }
  @if (formGroup?.controls && !control && maxLength) {
    @for (singleControl of formGroup?.controls | keyvalue; track singleControl.key) {
      @if (singleControl.key === selectedOption) {
        <small
        class="fudis-guidance__character-limit-indicator fudis-guidance__character-limit-indicator__{{
          _maxLengthWidth
        }}"
          [class.fudis-guidance__character-limit-indicator__float-right]="!helpText"
          >
          {{ singleControl.value.value?.length || 0 }}/{{ maxLength }}
          <span class="fudis-visually-hidden">{{ _maxLengthText | async }}</span>
        </small>
      }
      @if (
        singleControl.value.value?.length === _maxLengthAlertThreshold ||
        singleControl.value.value?.length === maxLength
        ) {
        <p
          class="fudis-guidance__character-limit-indicator__alert fudis-visually-hidden"
          role="alert"
          >
          {{ singleControl.value.value?.length || 0 }}/{{ maxLength }}
          {{ _maxLengthText | async }}</p
          >
        }
      }
    }
  </div>
  @if (
    control &&
    maxLength &&
    (control.value?.length === _maxLengthAlertThreshold || control.value?.length === maxLength)
    ) {
    <p class="fudis-guidance__character-limit-indicator__alert fudis-visually-hidden" role="alert"
      >{{ control.value?.length || 0 }}/{{ maxLength }} {{ _maxLengthText | async }}</p
      >
    }
